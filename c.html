<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat | Orbit</title>
    <link rel="stylesheet" href="/style.css" />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #0a111d;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        color: rgba(255, 255, 255, 0.85);
      }
      #chat {
        width: 700px;
        max-width: 95%;
        background: none;
        border-radius: 14px;
        display: flex;
        flex-direction: column;
        align-items: center;
        box-sizing: border-box;
      }
      #messages {
        width: 100%;
        height: 500px;
        overflow-y: scroll;
        border-radius: 14px;
        padding: 10px;
        background-color: rgba(25, 40, 60, 0.5);
        display: flex;
        flex-direction: column;
        gap: 2px;
        display: none;
      }
      .message-container {
        display: flex;
        flex-direction: column;
        align-self: flex-start;
        margin-bottom: 2px;
        opacity: 0;
        transform: translateY(10px);
        animation: fadeInUp 0.05s ease forwards;
      }
      @keyframes fadeInUp {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .message {
        padding: 6px 8px;
        border-radius: 4px;
        background-color: rgba(255, 255, 255, 0.12);
        font-size: 14px;
        color: rgba(255, 255, 255, 0.85);
        word-wrap: break-word;
        max-width: 70%;
        align-self: flex-start;
      }
      .my-message {
        background-color: rgba(0, 122, 255, 0.8);
        color: white;
        align-self: flex-end;
        max-width: 70%;
        padding: 6px 8px;
        border-radius: 8px;
        margin-bottom: 2px;
      }
      .system-message {
        text-align: center;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 5px;
      }
      .message-username {
        font-size: 12px;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.6);
        text-align: left;
        margin-bottom: 2px;
        margin-top: 8px;
      }
      .input-container {
        width: 100%;
        display: flex;
        align-items: center;
        margin: 10px 0;
        position: relative;
        gap: 10px;
      }
      input {
        flex: 1 1 auto;
        padding: 14px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        font-size: 16px;
        color: rgba(255, 255, 255, 0.75);
        background-color: rgba(0, 0, 0, 0.5);
        width: 100%;
        min-width: 0;
      }
      button {
        width: 49px;
        height: 49px;
        border-radius: 14px;
        background-color: rgba(255, 255, 255, 0.3);
        color: white;
        border: none;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.15s ease;
      }
      button:disabled {
        background-color: rgba(255, 255, 255, 0.15);
      }
      button:hover {
        background-color: rgba(255, 255, 255, 0.45);
        transform: scale(1.01);
      }
      .char-counter {
        position: absolute;
        top: 8px;
        right: 66px;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.4);
      }
      .room-selection {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
      }
      .room-button {
        width: 50px;
        padding: 10px;
        border-radius: 14px;
        background-color: rgba(255, 255, 255, 0.3);
        color: white;
        border: none;
        font-weight: bold;
        cursor: pointer;
        font-size: 14px;
        transition: 0.15s ease;
      }
      .room-button:hover {
        background-color: rgba(255, 255, 255, 0.45);
        transform: scale(1.01);
      }
      #countdown {
        position: absolute;
        bottom: 8px;
        right: 66px;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.4);
        display: none;
      }
      @media (max-width: 480px) {
        #chat {
          width: 90%;
        }
      }
      #chatArea {
        width: 100%;
        display: none;
      }
      #usernameSection {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="chat">
      <div id="roomSelection" class="room-selection">
        <button class="room-button" onclick="joinRoom('r1')">1</button>
        <button class="room-button" onclick="joinRoom('r2')">2</button>
        <button class="room-button" onclick="joinRoom('r3')">3</button>
      </div>

      <div id="messages"></div>

      <div id="usernameSection">
        <div class="input-container">
          <input
            id="username"
            type="text"
            placeholder="Username"
            autofocus
            maxlength="16"
          />
          <button id="joinButton"><i class="fas fa-check"></i></button>
          <div id="usernameCounter" class="char-counter">0/16</div>
        </div>
      </div>

      <div id="chatArea">
        <div class="input-container">
          <input
            id="messageInput"
            type="text"
            placeholder="Type a message"
            disabled
            maxlength="250"
          />
          <button id="sendButton" disabled>
            <i class="fas fa-paper-plane"></i>
          </button>
          <div id="messageCounter" class="char-counter">0/250</div>
          <div id="countdown"></div>
        </div>
      </div>
    </div>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      const socket = io(atob(atob("YUhSMGNITTZMeTkyWVhCdmNpMWphR0YwTG05dWNtVnVaR1Z5TG1OdmJRPT0=")));
      let username = "";
      let currentRoom = "";
      let lastMessageAuthor = "";
      function joinRoom(room) {
        currentRoom = room;
        document.getElementById("roomSelection").style.display = "none";
        document.getElementById("usernameSection").style.display = "flex";
      }
      document.getElementById("username").addEventListener("input", () => {
        const value = document.getElementById("username").value;
        document.getElementById(
          "usernameCounter"
        ).textContent = `${value.length}/16`;
      });
      document.getElementById("username").addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          document.getElementById("joinButton").click();
        }
      });
      document.getElementById("joinButton").onclick = () => {
        username = document.getElementById("username").value.trim();
        if (username && currentRoom) {
          socket.emit("join-room", { username: username, room: currentRoom });
          document.getElementById("usernameSection").style.display = "none";
          document.getElementById("chatArea").style.display = "flex";
          document.getElementById("messages").style.display = "flex";
          document.getElementById("messageInput").disabled = false;
          document.getElementById("sendButton").disabled = false;
          document.getElementById("messageInput").focus();
        }
      };
      const emojiMap = {
        ":smile:": "ðŸ˜Š",
        ":skull:": "ðŸ’€",
        ":thumbsup:": "ðŸ‘",
        ":wave:": "ðŸ‘‹",
        ":laugh:": "ðŸ˜‚",
        ":cry:": "ðŸ˜¢",
        ":cool:": "ðŸ˜Ž",
        ":fire:": "ðŸ”¥",
        ":star:": "â­",
      };
      function replaceEmoji(inputElement) {
        let text = inputElement.value;
        for (const [shortcut, emoji] of Object.entries(emojiMap)) {
          const regex = new RegExp(`${shortcut}(?=\\s|$)`, "g");
          text = text.replace(regex, emoji);
        }
        inputElement.value = text;
      }
      document
        .getElementById("messageInput")
        .addEventListener("input", (event) => {
          const inputElement = event.target;
          replaceEmoji(inputElement);
          const value = inputElement.value;
          document.getElementById(
            "messageCounter"
          ).textContent = `${value.length}/250`;
        });
      document
        .getElementById("messageInput")
        .addEventListener("keypress", (e) => {
          if (
            e.key === "Enter" &&
            !document.getElementById("sendButton").disabled
          ) {
            document.getElementById("sendButton").click();
          }
        });
      document.getElementById("sendButton").onclick = () => {
        const message = document.getElementById("messageInput").value.trim();
        if (message) {
          socket.emit("chat-message", {
            username: username,
            room: currentRoom,
            message: message,
          });
          document.getElementById("messageInput").value = "";
          document.getElementById("messageCounter").textContent = `0/250`;
          startCountdown();
        }
      };
      function startCountdown() {
        let countdown = 3;
        const countdownDisplay = document.getElementById("countdown");
        const sendButton = document.getElementById("sendButton");
        sendButton.disabled = true;
        countdownDisplay.innerHTML = `<i class="fas fa-clock"></i>&nbsp;${countdown}s`;
        countdownDisplay.style.display = "block";
        const interval = setInterval(() => {
          countdown--;
          countdownDisplay.innerHTML = `<i class="fas fa-clock"></i>&nbsp;${countdown}s`;
          if (countdown <= 0) {
            clearInterval(interval);
            countdownDisplay.style.display = "none";
            sendButton.disabled = false;
          }
        }, 1e3);
      }
      socket.on("chat-message", (data) => {
        const messagesBox = document.getElementById("messages");
        const messageContainer = document.createElement("div");
        if (
          data.message.includes(" joined the room.") ||
          data.message.includes(" left the room.")
        ) {
          messageContainer.classList.add("system-message");
          messageContainer.innerHTML = data.message;
        } else {
          const container = document.createElement("div");
          container.classList.add("message-container");
          const isMyMessage = data.username === username;
          const isSameAuthor =
            data.username === lastMessageAuthor &&
            !data.message.includes(" joined the room.") &&
            !data.message.includes(" left the room.");
          if (!isSameAuthor && !isMyMessage) {
            const usernameLabel = document.createElement("div");
            usernameLabel.classList.add("message-username");
            usernameLabel.textContent = data.username;
            container.appendChild(usernameLabel);
          }
          const messageBubble = document.createElement("div");
          messageBubble.textContent = data.message;
          if (isMyMessage) {
            messageBubble.classList.add("my-message");
          } else {
            messageBubble.classList.add("message");
          }
          container.appendChild(messageBubble);
          messageContainer.appendChild(container);
          lastMessageAuthor = data.username;
        }
        messagesBox.appendChild(messageContainer);
        messagesBox.scrollTop = messagesBox.scrollHeight;
      });
    </script>
  </body>
</html>
