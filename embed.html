<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scramjet Embed</title>
    <link rel="icon" href="https://ptza.env.pm/favicon.webp" />
    <link rel="prefetch" href="https://ptza.env.pm/scram/scramjet.worker.js" />
    <link rel="prefetch" href="https://ptza.env.pm/scram/scramjet.shared.js" />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&amp;family=Inter+Tight:ital,wght@0,100..900;1,100..900&amp;family=Inter:wght@100..900&amp;display=swap&amp;"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Hind:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Hind:wght@300;400;500;600;700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dreamland"></script>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        background-color: #000;
      }
      #iframe-container {
        width: 100%;
        height: 100%;
      }
      #iframe-container iframe {
        width: 100%;
        height: 100%;
        border: none;
        background-color: #fff;
      }
    </style>
    <script src="https://ptza.env.pm/baremux/index.js"></script>
    <script src="https://ptza.env.pm/scram/scramjet.all.js"></script>
    <script src="https://ptza.env.pm/config.js"></script>
  </head>
  <body>
    <div id="iframe-container"></div>
    <script>
      const { ScramjetController } = $scramjetLoadController();
      const scramjet = new ScramjetController({
        prefix: '/scramjet/',
        files: {
          wasm: 'https://ptza.env.pm/scram/scramjet.wasm.wasm',
          all: 'https://ptza.env.pm/scram/scramjet.all.js',
          sync: 'https://ptza.env.pm/scram/scramjet.sync.js'
        }
      });
      scramjet.init();
      navigator.serviceWorker.register('/sw.js');
      const connection = new BareMux.BareMuxConnection('https://ptza.env.pm/baremux/worker.js');
      const store = {
        wispurl: _CONFIG?.wispurl || (location.protocol === 'https:' ? 'wss' : 'ws') + '://' + location.host + '/wisp/',
        bareurl: _CONFIG?.bareurl || (location.protocol === 'https:' ? 'https' : 'http') + '://' + location.host + '/bare/'
      };

      function getParams() {
        const hash = decodeURIComponent(location.hash.substring(1));
        const noRedirect = location.search.includes('no-redirect');
        let url = hash || 'https://start.duckduckgo.com/';
        if (!url.startsWith('http://') && !url.startsWith('https://')) url = 'https://' + url;
        return { url, noRedirect };
      }

      async function loadFromHash() {
        const { url, noRedirect } = getParams();
        await waitForTransport();
        const frame = scramjet.createFrame();
        const iframe = frame.frame;

        if (noRedirect) {
          iframe.sandbox = 'allow-scripts allow-same-origin allow-modals allow-forms allow-popups-to-escape-sandbox';

          iframe.addEventListener('load', () => {
            try {
              const doc = iframe.contentDocument;

              const blockNewTabOnly = (e) => {
                const link = e.target.closest('a');
                if (link && link.getAttribute('target') === '_blank') {
                  e.preventDefault();
                  e.stopPropagation();
                }
              };

              doc.addEventListener('click', blockNewTabOnly, true);
              doc.addEventListener('auxclick', blockNewTabOnly, true);
            } catch (e) {}
          });
        }

        document.getElementById('iframe-container').appendChild(iframe);
        frame.go(url);
      }

      async function waitForTransport() {
        let attempts = 0;
        const maxAttempts = 10;
        while (attempts < maxAttempts) {
          try {
            await connection.setTransport('https://ptza.env.pm/epoxy/index.mjs', [{ wisp: store.wispurl }]);
            return;
          } catch {
            try {
              await connection.setTransport('https://ptza.env.pm/baremod/index.mjs', [store.bareurl]);
              return;
            } catch {
              try {
                await connection.setTransport('https://ptza.env.pm/libcurl/index.mjs', [{ wisp: store.wispurl }]);
                return;
              } catch {
                attempts++;
                if (attempts >= maxAttempts) throw new Error('No transport');
                await new Promise((r) => setTimeout(r, 100));
              }
            }
          }
        }
      }

      window.addEventListener('hashchange', () => {
        document.getElementById('iframe-container').innerHTML = '';
        loadFromHash();
      });
      window.addEventListener('load', loadFromHash);
    </script>
  </body>
</html>
