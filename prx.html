<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Orbit | Proxy</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="/res/orbit.png">
<link rel="stylesheet" href="/style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root{
  --main-bg:#0f1420;
  --panel:#1b2133;
  --panel2:#232a40;
  --text:#e6e9f2;
  --accent:#6c7cff;
}
html,body{
  margin:0;
  padding:0;
  height:100%;
  background:var(--main-bg);
  font-family:system-ui,sans-serif;
  color:var(--text);
  overflow:hidden;
}
#browserUI{
  position:fixed;
  top:110px;
  left:0;
  width:100%;
  background:var(--panel);
  padding:10px 14px;
  display:flex;
  align-items:center;
  gap:10px;
  z-index:5;
  box-sizing:border-box;
}
.nav-btn{
  background:var(--panel2);
  border:none;
  color:var(--text);
  padding:8px 10px;
  border-radius:8px;
  cursor:pointer;
}
.nav-btn:hover{
  background:var(--accent);
}
#urlInput{
  flex:1;
  padding:9px 14px;
  border-radius:30px;
  border:none;
  outline:none;
  font-size:14px;
  background:#0f1420;
  color:white;
}
#proxyContainer{
  position:fixed;
  top:170px;
  left:0;
  width:100%;
  height:calc(100vh - 170px);
}
#proxyFrame{
  width:100%;
  height:100%;
  border:none;
}
</style>
</head>

<body>
<header class="topbar" id="navMount"></header>
<nav class="menu" id="menu"></nav>

<div id="browserUI">
  <button class="nav-btn" id="backBtn"><i class="fa-solid fa-arrow-left"></i></button>
  <button class="nav-btn" id="forwardBtn"><i class="fa-solid fa-arrow-right"></i></button>
  <button class="nav-btn" id="refreshBtn"><i class="fa-solid fa-rotate-right"></i></button>
  <input id="urlInput" type="text" placeholder="Search or type a URL">
</div>

<div id="proxyContainer">
  <iframe id="proxyFrame"></iframe>
</div>

<script src="frame.js"></script>
<script src="script.js"></script>
<script>
const iframe = document.getElementById("proxyFrame");
const input = document.getElementById("urlInput");
const backBtn = document.getElementById("backBtn");
const forwardBtn = document.getElementById("forwardBtn");
const refreshBtn = document.getElementById("refreshBtn");

let historyStack = [];
let historyIndex = -1;
const key = "orbit";

function randomSubdomain(length = 6) {
  const chars = "abcdefghijklmnopqrstuvwxyz0123456789";
  let result = "";
  for (let i = 0; i < length; i++) {
    result += chars[Math.floor(Math.random() * chars.length)];
  }
  return result;
}

let sessionSub = sessionStorage.getItem("orbit_sub");
if (!sessionSub) {
  sessionSub = randomSubdomain();
  sessionStorage.setItem("orbit_sub", sessionSub);
}

function vigenereDecrypt(text, key) {
  let result = "";
  let j = 0;
  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    if (/[a-z]/i.test(c)) {
      const isUpper = c === c.toUpperCase();
      const base = isUpper ? 65 : 97;
      const k = key[j % key.length].toLowerCase().charCodeAt(0) - 97;
      const decoded = (c.charCodeAt(0) - base - k + 26) % 26 + base;
      result += String.fromCharCode(decoded);
      j++;
    } else {
      result += c;
    }
  }
  return result;
}

function looksLikeCipher(str) {
  return /^[a-z]+:\/\//i.test(str);
}

function normalizeURL(value) {
  value = value.trim();
  if (!value) return null;

  if (!value.startsWith("http://") && !value.startsWith("https://") && looksLikeCipher(value)) {
    value = vigenereDecrypt(value, key);
  }

  if (value.startsWith("http://") || value.startsWith("https://")) return value;
  if (value.includes(".")) return "https://" + value;
  return "https://start.duckduckgo.com/?q=" + encodeURIComponent(value);
}

function load(value, addHistory = true) {
  const decodedURL = normalizeURL(value);
  if (!decodedURL) {
    iframe.src = "newtab.html";
    input.value = "";
    return;
  }

  const encoded = encodeURIComponent(decodedURL);
  const embedURL = "https://" + sessionSub + ".gmsexpress.org/scramjet/" + encoded;

  iframe.src = embedURL;
  input.value = value;

  if (addHistory) {
    historyStack = historyStack.slice(0, historyIndex + 1);
    historyStack.push(value);
    historyIndex++;
    location.hash = encodeURIComponent(value);
  }
}

input.addEventListener("keydown", e => {
  if (e.key === "Enter") load(input.value);
});

backBtn.onclick = () => {
  if (historyIndex > 0) {
    historyIndex--;
    load(historyStack[historyIndex], false);
  }
};

forwardBtn.onclick = () => {
  if (historyIndex < historyStack.length - 1) {
    historyIndex++;
    load(historyStack[historyIndex], false);
  }
};

refreshBtn.onclick = () => {
  if (historyIndex >= 0) {
    load(historyStack[historyIndex], false);
  }
};

window.addEventListener("hashchange", () => {
  const hash = decodeURIComponent(location.hash.slice(1));
  if (hash) {
    load(hash, false);
  }
});

window.addEventListener("load", () => {
  const hash = decodeURIComponent(location.hash.slice(1));
  if (hash) {
    load(hash);
  } else {
    load("https://start.duckduckgo.com");
  }
});
</script>

</body>
</html>
